# STM32 与 Ubuntu 通过 UART 串口通信延迟测试

## 接收接收字节延迟测试

### 条件

- PC 和 STM32 波特率 921600
- PC 平台为个人 Ubuntu20.04 系统
- stm32 定时 2ms，UART 采用 DMA 方式发送字节

### 实验细节

- 1 个字符，则大约 2050us, 2050us, 3900us, 2us 依次循环
- 4 个字符，则大约 2000 + 3 个 2，4000 + 7 个 2，6000 + 11 个 2 随机出现
- 8 个字符，则大约 2000，4000，6000，8000随机出现
- 16 个字符，则 4000 稳定出现
- 32 个字符，则 2000 稳定出现，
- 33 个字符， 则会很规律的间隔 32 次出现一个 300 多微秒
- 34 个字符， 则会很规律的间隔 16 次出现一个 300 多微秒
- 36 个字符则间隔 8 次，40 个字符则间隔 4 次，48 个字符则 2178us 和 1823us 循环（而非 2000us）
- 64 个字符，则 2000 稳定出现
- 96 个字符，则 2000 稳定出现
- 128 个字符，则 2000 稳定出现
- 129 个字符，则会隔 32 个冒出来 2300us
- 130 个字符，则会隔 16 个冒出来两个 2900us + 1400us
- 160 个字符，则 2000 稳定出现。理论计算可得, 160 * 10 / 921600 = 1.73ms,
- 192 个字符，则 4000 稳定出现。理论计算可得, 192 * 10 / 921600 = 2.08ms, 确实由于波特率限制不能 2000us 了
- 256 个字符，则 4000 稳定出现

### 结论

- 从实验结果可猜测 CH341 芯片内部有 32 个字节缓冲区，所以需要用 32 个字符的倍数通信。
- Google 关键词 CH341 和 32 bytes，可找到一些资料证实上述猜想。如[LX08H whit chip CH341 only receive when buffer contains 32 bytes](https://stackoverflow.com/questions/45880337/lx08h-whit-chip-ch341-only-receive-when-buffer-contains-32-bytes)

## 发送和接收字节延迟测试

### 波特率 921600 条件下，个人 Ubuntu20.04 系统进行试验

- 32 字节实测发送延迟 61us，接收延迟 800us
- 64 字符实测发送延迟 100us，接收延迟 1500us.
- 96 字符实测发送延迟 500us，接收延迟 1800us
- 128 字符实测发送延迟 900us，接收延迟 2100us, 然而报错“接收到的字节和发送的字节不一致！”(不过 STM32 复位一次又好了)
- 160 字符实测发送延迟 1300us，接收延迟 2400us
- 192 字符实测发送延迟 1650us，接收延迟 2850us


### 波特率 1500000 条件下，个人 Ubuntu20.04 系统进行试验

- 实测 64 字节发送延迟 100us，接收延迟 950us
- 理论计算可得, 64 * 2 * 10 / 1500000 = 0.853ms, 实测结果和最理想的结果相差不大
- 实测 160 字节发送延迟 900us，接收延迟 1550us
- 理论计算可得, 160 * 2 * 10 / 1500000 = 2.13ms, 实测结果和最理想的结果相差不大


### 波特率 2000000 条件下，个人 Ubuntu20.04 系统进行试验

- 实测程序 1 秒内就会卡住,接收不到应有的全部数据。自己在串口助手也会观察到几十帧正常数据就丢失几个字符的情况
- 这不是偶然,而是每次都会发生
- 猜测是波特率误差的原因